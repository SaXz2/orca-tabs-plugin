# DOMæ›´æ–°ä¼˜åŒ–è¯´æ˜

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

è§£å†³ `Forced reflow` è­¦å‘Šï¼Œå‡å°‘ DOM æ“ä½œè€—æ—¶ä» 79-250ms åˆ° <30msã€‚

## âš ï¸ åŸæœ‰é—®é¢˜

### é—®é¢˜1: innerHTML = '' æ¸…ç©ºå®¹å™¨
```typescript
// âŒ é—®é¢˜ä»£ç 
this.tabContainer.innerHTML = '';  // è§¦å‘å¼ºåˆ¶é‡æ’
```

**åæœï¼š**
- æµè§ˆå™¨å¼ºåˆ¶é‡æ–°è®¡ç®—å¸ƒå±€
- æ¸…ç©ºæ‰€æœ‰å­å…ƒç´ ï¼ŒåŒ…æ‹¬äº‹ä»¶ç›‘å¬å™¨
- è§¦å‘å¤§é‡çš„ DOM æ“ä½œ
- æ§åˆ¶å°è­¦å‘Šï¼š`Forced reflow while executing JavaScript took 79-250ms`

### é—®é¢˜2: å¾ªç¯appendChild
```typescript
// âŒ é—®é¢˜ä»£ç 
targetTabs.forEach((tab) => {
  const tabElement = this.createTabElement(tab);
  this.tabContainer.appendChild(tabElement);  // æ¯æ¬¡éƒ½è§¦å‘é‡æ’
});
```

**åæœï¼š**
- æ¯æ¬¡æ·»åŠ å…ƒç´ éƒ½è§¦å‘ä¸€æ¬¡é‡æ’
- Nä¸ªæ ‡ç­¾ = Næ¬¡é‡æ’
- ç´¯ç§¯è€—æ—¶æ˜¾è‘—

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### ä¼˜åŒ–1: é€‰æ‹©æ€§åˆ é™¤å…ƒç´ 

**ä¼˜åŒ–å‰:**
```typescript
this.tabContainer.innerHTML = '';  // âŒ æ¸…ç©ºæ•´ä¸ªå®¹å™¨
```

**ä¼˜åŒ–å:**
```typescript
// âœ… åªåˆ é™¤æ ‡ç­¾å…ƒç´ ï¼Œä¿ç•™å…¶ä»–å…ƒç´ 
const tabsToRemove = this.tabContainer.querySelectorAll('.orca-tab');
tabsToRemove.forEach(tab => tab.remove());
```

**ä¼˜åŠ¿ï¼š**
- ä¸å½±å“å…¶ä»–å…ƒç´ ï¼ˆæ‹–æ‹½æ‰‹æŸ„ã€æŒ‰é’®ç­‰ï¼‰
- å‡å°‘DOMæ ‘çš„é‡å»º
- ä¿ç•™äº‹ä»¶ç›‘å¬å™¨

### ä¼˜åŒ–2: ä½¿ç”¨ DocumentFragment æ‰¹é‡æ·»åŠ 

**ä¼˜åŒ–å‰:**
```typescript
targetTabs.forEach((tab) => {
  const tabElement = this.createTabElement(tab);
  this.tabContainer.appendChild(tabElement);  // âŒ Næ¬¡DOMæ“ä½œ
});
```

**ä¼˜åŒ–å:**
```typescript
// âœ… ä½¿ç”¨DocumentFragmentæ‰¹é‡æ·»åŠ 
const fragment = document.createDocumentFragment();
targetTabs.forEach((tab) => {
  const tabElement = this.createTabElement(tab);
  fragment.appendChild(tabElement);  // æ·»åŠ åˆ°å†…å­˜ä¸­çš„fragment
});

// ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰æ ‡ç­¾
this.tabContainer.appendChild(fragment);  // âœ… 1æ¬¡DOMæ“ä½œ
```

**ä¼˜åŠ¿ï¼š**
- Næ¬¡DOMæ“ä½œ â†’ 1æ¬¡DOMæ“ä½œ
- å‡å°‘ (N-1) æ¬¡é‡æ’
- æ˜¾è‘—æå‡æ€§èƒ½

## ğŸ“Š é¢„æœŸæ•ˆæœ

### æ€§èƒ½æå‡
| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **DOMæ“ä½œæ¬¡æ•°** | N+1æ¬¡ | 2æ¬¡ | â†“ ~95% |
| **é‡æ’æ¬¡æ•°** | Næ¬¡ | 1-2æ¬¡ | â†“ ~90% |
| **UIæ›´æ–°è€—æ—¶** | 79-250ms | **<30ms** | â†“ 70-80% |
| **Forced reflow** | é¢‘ç¹ | **æ¶ˆé™¤** | âœ… |

### å¥åº·åˆ†æ•°
- **å½“å‰**: 2/100
- **é¢„æœŸ**: 70-80/100
- **æå‡**: 35-40å€

## ğŸ”§ æŠ€æœ¯åŸç†

### DocumentFragment
`DocumentFragment` æ˜¯ä¸€ä¸ªè½»é‡çº§çš„æ–‡æ¡£å¯¹è±¡ï¼Œå­˜åœ¨äºå†…å­˜ä¸­ï¼š
- å‘ fragment æ·»åŠ å…ƒç´ ä¸ä¼šè§¦å‘é‡æ’
- å°† fragment æ·»åŠ åˆ° DOM åªè§¦å‘ä¸€æ¬¡é‡æ’
- æ·»åŠ å fragment è‡ªåŠ¨æ¸…ç©ºï¼Œå¯é‡å¤ä½¿ç”¨

### é€‰æ‹©æ€§åˆ é™¤
åªåˆ é™¤éœ€è¦æ›´æ–°çš„å…ƒç´ ï¼Œè€Œä¸æ˜¯æ¸…ç©ºæ•´ä¸ªå®¹å™¨ï¼š
- ä¿ç•™é™æ€å…ƒç´ ï¼ˆæ‹–æ‹½æ‰‹æŸ„ã€æŒ‰é’®ï¼‰
- å‡å°‘ DOM æ ‘çš„é‡å»º
- ä¿ç•™äº‹ä»¶ç›‘å¬å™¨å’Œå¼•ç”¨

## âœ… éªŒè¯æ–¹æ³•

### 1. æ£€æŸ¥æ§åˆ¶å°è­¦å‘Š
ä¼˜åŒ–ååº”è¯¥**ä¸å†çœ‹åˆ°**æˆ–**å¤§å¹…å‡å°‘**ï¼š
```
[Violation] Forced reflow while executing JavaScript took XXms
```

### 2. æ€§èƒ½æµ‹è¯•
åœ¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
// æµ‹è¯•æ ‡ç­¾åˆ‡æ¢æ€§èƒ½
console.time('tab-update');
// åˆ‡æ¢æ ‡ç­¾æˆ–æ›´æ–°UI
console.timeEnd('tab-update');
// ç›®æ ‡: < 30ms
```

### 3. ç”¨æˆ·ä½“éªŒ
- âœ… æ ‡ç­¾åˆ‡æ¢æµç•…æ— å¡é¡¿
- âœ… æ‹–æ‹½æ’åºé¡ºæ»‘
- âœ… é¡µé¢å“åº”å¿«é€Ÿ

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. ä¿æŒå‘åå…¼å®¹
ä¼˜åŒ–ä»…æ”¹å˜DOMæ“ä½œæ–¹å¼ï¼Œä¸æ”¹å˜åŠŸèƒ½é€»è¾‘ã€‚

### 2. ä¿ç•™å…ƒç´ é¡ºåº
ä½¿ç”¨ DocumentFragment ä¼šä¿æŒå…ƒç´ çš„æ·»åŠ é¡ºåºã€‚

### 3. äº‹ä»¶ç›‘å¬å™¨
é€‰æ‹©æ€§åˆ é™¤ä¸ä¼šå½±å“ä¿ç•™å…ƒç´ çš„äº‹ä»¶ç›‘å¬å™¨ã€‚

## ğŸš€ åç»­ä¼˜åŒ–æ–¹å‘

è™½ç„¶æœ¬æ¬¡ä¼˜åŒ–ä¸»è¦è§£å†³Forced Reflowé—®é¢˜ï¼Œä½†è¿˜æœ‰è¿›ä¸€æ­¥ä¼˜åŒ–ç©ºé—´ï¼š

### çŸ­æœŸï¼ˆå·²å®æ–½ï¼‰
- [x] ç§»é™¤ innerHTML æ¸…ç©º
- [x] ä½¿ç”¨ DocumentFragment æ‰¹é‡æ·»åŠ 
- [x] é€‰æ‹©æ€§åˆ é™¤å…ƒç´ 

### ä¸­æœŸï¼ˆå¾…å®æ–½ï¼‰
- [ ] å®ç°çœŸæ­£çš„å¢é‡DOMæ›´æ–°ï¼ˆDiffç®—æ³•ï¼‰
- [ ] åªæ›´æ–°å˜åŒ–çš„æ ‡ç­¾ï¼Œä¸é‡å»ºæ‰€æœ‰æ ‡ç­¾
- [ ] ä½¿ç”¨è™šæ‹ŸDOMå‡å°‘ç›´æ¥DOMæ“ä½œ

### é•¿æœŸï¼ˆè§„åˆ’ä¸­ï¼‰
- [ ] è™šæ‹Ÿæ»šåŠ¨å¤„ç†å¤§é‡æ ‡ç­¾
- [ ] Web Workerå¤„ç†æ•°æ®è½¬æ¢
- [ ] æ‡’åŠ è½½æ ‡ç­¾å†…å®¹

## ğŸ“– ç›¸å…³èµ„æº

- **MDN DocumentFragment**: https://developer.mozilla.org/en-US/docs/Web/API/DocumentFragment
- **æµè§ˆå™¨é‡æ’ä¸é‡ç»˜**: https://developers.google.com/speed/docs/insights/browser-reflow
- **DOMæ€§èƒ½ä¼˜åŒ–**: https://web.dev/dom-performance/

---

**ä¼˜åŒ–æ—¥æœŸ**: 2025-10-04  
**ä¼˜åŒ–ç‰ˆæœ¬**: v2.6.0+  
**é¢„æœŸæå‡**: UIæ›´æ–°è€—æ—¶ â†“ 70-80%ï¼ŒForced reflowæ¶ˆé™¤

