<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content-Visibility ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .test-container {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .hidden {
            content-visibility: hidden;
            height: 0;
            overflow: hidden;
        }

        .visible {
            content-visibility: visible;
            padding: 10px;
            background: #f0f8ff;
            margin: 10px 0;
        }

        #sidebar {
            content-visibility: hidden;
            --orca-sidebar-width: 240px;
            background: #333;
            color: white;
            padding: 20px;
        }

        .orca-hideable-hidden {
            content-visibility: hidden;
            display: flex;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .test-result {
            margin: 10px 0;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Content-Visibility æ¸²æŸ“è­¦å‘Šä¿®å¤æµ‹è¯•</h1>

    <div class="test-container">
        <h2>ğŸ¯ æµ‹è¯•ç›®æ ‡</h2>
        <p>éªŒè¯ä¿®å¤ç³»ç»Ÿæ˜¯å¦èƒ½å¤Ÿæœ‰æ•ˆé¿å…å¯¹å…·æœ‰ <code>content-visibility: hidden</code> å±æ€§çš„å…ƒç´ è¿›è¡Œæ¸²æŸ“æ“ä½œã€‚</p>
    </div>

    <div class="test-container">
        <h2>ğŸ§ª æµ‹è¯•ç¯å¢ƒ</h2>
        <div id="sidebar" class="hidden">
            è¿™æ˜¯æ¨¡æ‹Ÿçš„ sidebar å…ƒç´ ï¼Œå…·æœ‰ content-visibility: hidden
        </div>

        <div class="orca-hideable-hidden">
            è¿™æ˜¯æ¨¡æ‹Ÿçš„ orca-hideable-hidden å…ƒç´ ï¼Œå…·æœ‰ content-visibility: hidden
        </div>

        <div class="visible">
            è¿™æ˜¯å¯è§å…ƒç´ ï¼Œåº”è¯¥å…è®¸æ­£å¸¸çš„æ¸²æŸ“æ“ä½œ
        </div>
    </div>

    <div class="test-container">
        <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
        <div id="test-results"></div>
    </div>

    <div class="test-container">
        <h2>ğŸ”§ ä¿®å¤æ–¹æ¡ˆè¯´æ˜</h2>
        <h3>1. ç®€å•ç›´æ¥çš„ä¿®å¤æ–¹æ³•</h3>
        <div class="code-block">
// å®‰å…¨çš„æ ·å¼è®¾ç½®å‡½æ•°
function safeSetElementStyles(element, styles) {
  if (!isElementVisible(element)) {
    return false;
  }

  try {
    element.style.cssText = styles;
    return true;
  } catch (error) {
    console.error('è®¾ç½®æ ·å¼å¤±è´¥:', error);
    return false;
  }
}

// å¿«é€Ÿå…ƒç´ å¯è§æ€§æ£€æŸ¥
function isElementVisible(element) {
  try {
    const style = window.getComputedStyle(element);

    if (style.contentVisibility === 'hidden') {
      return false;
    }
    if (style.display === 'none') {
      return false;
    }
    if (style.visibility === 'hidden') {
      return false;
    }
    if (style.opacity === '0') {
      return false;
    }

    return true;
  } catch (error) {
    return true; // æ£€æŸ¥å¤±è´¥ï¼Œå‡è®¾å¯è§
  }
}
        </div>

        <h3>2. å…³é”®ä¿®å¤ç‚¹</h3>
        <ul>
            <li>âœ… ä¿®å¤äº† <code>tabContainer.style.cssText</code> çš„ç›´æ¥è®¾ç½®</li>
            <li>âœ… ä¿®å¤äº† <code>appendChild</code> æ“ä½œçš„æ£€æŸ¥</li>
            <li>âœ… ä¿®å¤äº† UI åˆ›å»ºå‡½æ•°ä¸­çš„æ ·å¼è®¾ç½®</li>
            <li>âœ… æ·»åŠ äº† requestAnimationFrame çš„å¯è§æ€§æ£€æŸ¥</li>
        </ul>
    </div>

    <script>
        // æ¨¡æ‹Ÿä¿®å¤å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function isElementVisible(element) {
            try {
                const style = window.getComputedStyle(element);

                if (style.contentVisibility === 'hidden') {
                    return false;
                }
                if (style.display === 'none') {
                    return false;
                }
                if (style.visibility === 'hidden') {
                    return false;
                }
                if (style.opacity === '0') {
                    return false;
                }

                return true;
            } catch (error) {
                return true;
            }
        }

        function safeSetElementStyles(element, styles) {
            if (!isElementVisible(element)) {
                return false;
            }

            try {
                element.style.cssText = styles;
                return true;
            } catch (error) {
                console.error('è®¾ç½®æ ·å¼å¤±è´¥:', error);
                return false;
            }
        }

        function safeRenderOperation(element, operation) {
            if (!isElementVisible(element)) {
                console.log('è·³è¿‡å¯¹éšè—å…ƒç´ çš„æ¸²æŸ“æ“ä½œ');
                return false;
            }

            try {
                operation();
                return true;
            } catch (error) {
                console.error('æ¸²æŸ“æ“ä½œå¤±è´¥:', error);
                return false;
            }
        }

        // æµ‹è¯•å‡½æ•°
        function runTests() {
            const results = document.getElementById('test-results');
            let testResults = '';

            // æµ‹è¯•1: æ£€æŸ¥éšè—å…ƒç´ æ£€æµ‹
            const sidebar = document.getElementById('sidebar');
            const isSidebarHidden = !isElementVisible(sidebar);
            testResults += `
                <div class="test-result ${isSidebarHidden ? 'success' : 'error'}">
                    æµ‹è¯•1: Sidebar éšè—æ£€æµ‹ - ${isSidebarHidden ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
                </div>
            `;

            // æµ‹è¯•2: å®‰å…¨æ ·å¼è®¾ç½®
            const sidebarStyleSuccess = !safeSetElementStyles(sidebar, 'color: red;');
            testResults += `
                <div class="test-result ${sidebarStyleSuccess ? 'success' : 'error'}">
                    æµ‹è¯•2: å®‰å…¨æ ·å¼è®¾ç½® - ${sidebarStyleSuccess ? 'âœ… æ­£ç¡®è·³è¿‡' : 'âŒ åº”è¯¥è·³è¿‡'}
                </div>
            `;

            // æµ‹è¯•3: å¯è§å…ƒç´ æ“ä½œ
            const visibleElement = document.querySelector('.visible');
            const visibleStyleSuccess = safeSetElementStyles(visibleElement, 'background: #e8f5e8;');
            testResults += `
                <div class="test-result ${visibleStyleSuccess ? 'success' : 'error'}">
                    æµ‹è¯•3: å¯è§å…ƒç´ æ“ä½œ - ${visibleStyleSuccess ? 'âœ… æˆåŠŸè®¾ç½®' : 'âŒ è®¾ç½®å¤±è´¥'}
                </div>
            `;

            // æµ‹è¯•4: å®‰å…¨æ¸²æŸ“æ“ä½œ
            let renderSuccess = true;
            safeRenderOperation(sidebar, () => {
                renderSuccess = false; // è¿™ä¸åº”è¯¥æ‰§è¡Œ
            });

            testResults += `
                <div class="test-result ${renderSuccess ? 'success' : 'error'}">
                    æµ‹è¯•4: å®‰å…¨æ¸²æŸ“æ“ä½œ - ${renderSuccess ? 'âœ… æ­£ç¡®è·³è¿‡' : 'âŒ æ„å¤–æ‰§è¡Œ'}
                </div>
            `;

            results.innerHTML = testResults;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', runTests);

        // ç›‘å¬æ§åˆ¶å°è­¦å‘Š
        const originalWarn = console.warn;
        const originalError = console.error;
        let warningCount = 0;

        console.warn = function(...args) {
            const message = args.join(' ');
            if (message.includes('content-visibility')) {
                warningCount++;
                const results = document.getElementById('test-results');
                if (results) {
                    results.innerHTML += `
                        <div class="test-result error">
                            âš ï¸ æ£€æµ‹åˆ° content-visibility è­¦å‘Š: ${message}
                        </div>
                    `;
                }
            }
            originalWarn.apply(console, args);
        };

        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('Rendering was performed')) {
                const results = document.getElementById('test-results');
                if (results) {
                    results.innerHTML += `
                        <div class="test-result error">
                            ğŸš¨ æ£€æµ‹åˆ°æ¸²æŸ“è­¦å‘Š: ${message}
                        </div>
                    `;
                }
            }
            originalError.apply(console, args);
        };
    </script>
</body>
</html>