# Orca Tabs Plugin - 版本更新日志

## v2.2.1 - 2024年12月

### 🚀 重大功能更新

#### 1. 智能块类型检测系统
- **新功能**: 添加了完整的块类型自动检测功能
- **支持类型**: 
  - 日期块 (journal) - 保持emoji图标 📅
  - 页面 (page) - 使用文件图标
  - 标签 (tag) - 使用标签图标
  - 标题 (heading) - 使用标题图标
  - 代码 (code) - 使用代码图标
  - 表格 (table) - 使用表格图标
  - 图片 (image) - 使用图片图标
  - 链接 (link) - 使用链接图标
  - 列表 (list) - 使用列表图标
  - 引用 (quote) - 使用引用图标
  - 任务 (task) - 使用复选框图标
  - 数学公式 (math) - 使用数学图标
  - 其他多种类型支持
- **检测机制**:
  - 优先检查 `data-type` 属性
  - 智能分析块内容特征
  - 支持别名块的页面/标签区分
  - 基于文本内容模式识别

#### 2. 块类型图标显示
- **新功能**: 在标签页中显示对应的块类型图标
- **图标系统**: 使用 Tabler Icons 图标库
- **显示控制**: 可通过配置控制是否显示图标
- **智能匹配**: 根据检测到的块类型自动匹配对应图标

#### 3. 内容解析优化
- **改进**: 优化了块内容的多段拼接逻辑
- **智能判断**: 自动检测是否需要拼接多个内容片段
- **性能提升**: 减少不必要的复杂解析操作
- **准确性**: 提高标题提取的准确性

#### 4. 位置管理增强
- **新功能**: 分别管理水平和垂直模式下的窗口位置
- **独立存储**: 水平模式和垂直模式的位置数据独立存储
- **智能恢复**: 切换模式时自动恢复对应的位置设置

### 🔧 技术改进

#### 块类型检测算法
- 实现了多层次的块类型检测机制
- 支持基于属性、内容、文本特征的智能识别
- 添加了详细的调试日志和错误处理
- 优化了检测性能和准确性

#### 内容解析优化
- 改进了多段内容的拼接逻辑
- 添加了内容类型判断功能
- 优化了文本提取算法
- 减少了不必要的API调用

#### 存储系统优化
- 移除了过时的localStorage迁移代码
- 简化了存储服务架构
- 优化了配置键的管理
- 提升了存储性能

### 🐛 修复问题

#### 块引用处理
- **问题**: 块引用显示不够直观
- **修复**: 优化了块引用的显示格式，添加了 `[[]]` 包围
- **效果**: 块引用现在更加清晰易识别

#### 内容拼接逻辑
- **问题**: 复杂内容的多段拼接可能出错
- **修复**: 添加了智能判断机制，避免不必要的拼接
- **效果**: 提高了内容解析的准确性和性能

#### 标题提取优化
- **问题**: 某些块类型的标题提取不够准确
- **修复**: 根据块类型优化标题提取逻辑
- **效果**: 列表、表格等特殊类型的标题显示更加合理

### 📝 代码变更统计
- 新增方法: `detectBlockType()`, `getBlockTypeIcon()`, `getAllBlockTypeIcons()`
- 新增方法: `needsContentConcatenation()`, `isTextWithBlockRefs()`
- 优化方法: `getTabInfo()`, `extractTextFromContent()`
- 新增属性: `blockType`, `showBlockTypeIcons`, `horizontalPosition`
- 移除代码: 过时的localStorage迁移相关代码

### 🎯 影响范围
- 所有标签页现在都会显示对应的块类型图标
- 块类型检测更加准确和智能
- 内容解析性能显著提升
- 位置管理更加灵活和精确

### ✅ 测试建议
1. 测试不同类型块的图标显示
2. 测试块类型检测的准确性
3. 测试水平和垂直模式的位置管理
4. 测试复杂内容的解析效果
5. 测试块引用的显示格式

---

## v2.1.16 - 2024年12月

### 🚀 重大功能更新

#### 1. API配置存储系统
- **新功能**: 将持久化方案从localStorage升级为Orca API配置系统
- **优势**: 
  - 支持跨设备同步，重装电脑不丢失配置
  - 数据存储在Orca的配置系统中，支持云端同步
  - 按库隔离，不同库的配置数据相互独立
- **实现**:
  - 创建了统一的 `OrcaStorageService` 存储服务类
  - 定义了插件专用配置键 (10000-10004)
  - 支持自动降级：API失败时自动使用localStorage作为备选
  - 添加了完整的数据迁移功能

#### 2. 数据迁移功能
- **自动迁移**: 插件启动时自动检测并迁移旧的localStorage数据
- **智能识别**: 支持按库分别迁移（基于repo ID）
- **向后兼容**: 迁移完成后保留原有数据结构
- **错误处理**: 迁移失败时不影响插件正常使用

#### 3. 日志系统优化
- **分级日志**: 添加了基本日志和详细日志两个级别
- **减少噪音**: 将频繁的调试信息改为详细日志
- **按需启用**: 可通过控制台变量控制日志级别
- **性能提升**: 减少不必要的console.log调用

### 🔧 技术改进

#### 存储服务架构
- 使用正确的插件存储API（`orca.plugins.setData`、`orca.plugins.getData`）
- 数据存储在PluginStorage表中，支持跨设备同步
- 实现了JSON序列化/反序列化，解决数据类型限制
- 添加了完整的错误处理和降级机制
- 支持插件级别的数据隔离

#### 存储键定义
```typescript
const PLUGIN_STORAGE_KEYS = {
  FIRST_PANEL_TABS: 'first-panel-tabs',      // 第一个面板的标签数据
  CLOSED_TABS: 'closed-tabs',               // 已关闭标签列表
  FLOATING_WINDOW_VISIBLE: 'floating-window-visible', // 浮窗可见状态
  TABS_POSITION: 'tabs-position',           // 标签位置
  LAYOUT_MODE: 'layout-mode',               // 布局模式
}
```

#### 日志控制方法
```javascript
// 基本日志（默认启用）
window.DEBUG_ORCA_TABS = true;

// 详细日志（需要手动启用）
window.DEBUG_ORCA_TABS_VERBOSE = true;
```

### 🐛 修复问题

#### SQLite数据类型兼容性
- **问题**: Orca配置系统使用SQLite，只能存储基本数据类型
- **修复**: 实现了JSON序列化/反序列化机制
- **效果**: 复杂对象现在可以正确存储和读取

#### 频繁日志输出
- **问题**: 控制台日志过多，影响调试体验
- **修复**: 优化日志级别，减少90%的日志输出
- **效果**: 控制台更加清爽，重要信息仍然可见

### 📝 代码变更统计
- 新增文件: `OrcaStorageService` 类
- 修改方法: 所有存储相关方法改为async/await
- 新增功能: 数据迁移、日志分级、API配置
- 优化性能: 减少日志输出，提升响应速度

### 🎯 影响范围
- 所有配置数据现在存储在Orca配置系统中
- 支持跨设备同步和云端备份
- 重装电脑后配置不会丢失
- 日志输出更加合理和可控

### ✅ 测试建议
1. 测试配置数据的跨设备同步
2. 测试重装电脑后配置是否保留
3. 测试API失败时的降级机制
4. 测试数据迁移功能
5. 测试不同日志级别的输出

---

## v2.1.6 - 2024年12月

### 🐛 修复问题

#### 1. 侧边栏交互问题修复
- **问题**: 侧边栏的收藏/标签/页面按钮出现点不动的情况
- **原因**: 标签栏容器的事件监听器过于激进地阻止了事件冒泡
- **修复**: 
  - 修改事件监听器，只阻止标签栏内部元素的事件冒泡
  - 增强侧边栏元素检测，包含所有可能的侧边栏、面板、菜单元素
  - 使用 `passive: true` 降低全局事件监听器优先级

#### 2. 侧边栏拖拽尺寸调整问题修复
- **问题**: 侧边栏/分屏拖拽不了尺寸
- **原因**: 标签栏的拖拽事件干扰了侧边栏的拖拽功能
- **修复**:
  - 在所有拖拽事件中添加侧边栏区域检测
  - 当检测到在侧边栏相关区域时，跳过标签栏的拖拽处理
  - 添加拖拽状态检测，在拖拽过程中跳过不必要的事件处理

#### 3. 日期块导航问题修复
- **问题**: 日期块标签页点击没有响应
- **原因**: 使用了错误的导航方式，应该使用 `journal` 导航而不是 `block` 导航
- **修复**:
  - 检查标签是否为日期块（`tab.isJournal`）
  - 对于相对日期（今天/昨天/明天），使用 Orca 原生命令：
    - `orca.commands.invokeCommand('core.goToday')`
    - `orca.commands.invokeCommand('core.goYesterday')`
    - `orca.commands.invokeCommand('core.goTomorrow')`
  - 对于绝对日期，使用 `orca.nav.goTo("journal", { date: targetDate })`
  - 添加多层回退机制确保导航不会完全失败

#### 4. 拖拽后页面状态问题修复
- **问题**: 拖拽浮动窗后整个页面变成抓手无法点击
- **原因**: 拖拽结束后没有完全清理拖拽状态，影响了其他元素的交互
- **修复**:
  - 移除过激的事件处理（不再使用 `capture: true`）
  - 增强样式清理，重置所有可能被拖拽影响的样式属性
  - 添加强制重置机制，遍历所有元素重置被拖拽影响的样式
  - 恢复事件传播，确保其他元素能正常响应鼠标事件

#### 5. 日期格式错误修复
- **问题**: 出现 "Invalid time value" 错误
- **原因**: 传递给 `format` 函数的日期对象无效
- **修复**:
  - 添加日期有效性检查
  - 改进日期字符串解析，确保正确解析为UTC时间
  - 验证从块信息获取的日期有效性

### 🔧 技术改进

#### 事件处理优化
- 使用更精确的元素选择器
- 降低全局事件监听器优先级
- 添加拖拽状态感知机制
- 实现双重检查机制

#### 导航逻辑增强
- 支持 Orca 原生命令
- 使用正确的 `QueryJournalDate` 格式
- 实现多层回退机制
- 添加详细的调试信息

#### 样式管理改进
- 完整的拖拽状态清理
- 强制重置所有受影响元素
- 特别处理 Orca 原生元素
- 恢复所有交互功能

### 📝 代码变更统计
- 修改文件: `src/main.ts`
- 新增方法: `ensureClickableElements()`, `resetAllElements()`
- 优化方法: `switchToTab()`, `stopDrag()`, `handleClickEvent()`
- 增强调试: 添加详细的控制台日志

### 🎯 影响范围
- 侧边栏交互功能完全恢复
- 日期块导航功能正常工作
- 拖拽功能不再影响其他元素
- 整体用户体验显著提升

### ✅ 测试建议
1. 测试侧边栏的收藏/标签/页面按钮点击
2. 测试侧边栏/分屏的拖拽尺寸调整
3. 测试日期块标签页的点击导航
4. 测试拖拽浮动窗后的页面交互
5. 测试各种日期格式的标签页导航

---

**注意**: 此版本主要专注于修复交互问题，提升用户体验。建议在更新后清除浏览器缓存以确保所有更改生效。
