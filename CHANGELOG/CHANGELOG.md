# Orca Tabs Plugin - 版本更新日志

## v2.1.6 - 2024年12月

### 🐛 修复问题

#### 1. 侧边栏交互问题修复
- **问题**: 侧边栏的收藏/标签/页面按钮出现点不动的情况
- **原因**: 标签栏容器的事件监听器过于激进地阻止了事件冒泡
- **修复**: 
  - 修改事件监听器，只阻止标签栏内部元素的事件冒泡
  - 增强侧边栏元素检测，包含所有可能的侧边栏、面板、菜单元素
  - 使用 `passive: true` 降低全局事件监听器优先级

#### 2. 侧边栏拖拽尺寸调整问题修复
- **问题**: 侧边栏/分屏拖拽不了尺寸
- **原因**: 标签栏的拖拽事件干扰了侧边栏的拖拽功能
- **修复**:
  - 在所有拖拽事件中添加侧边栏区域检测
  - 当检测到在侧边栏相关区域时，跳过标签栏的拖拽处理
  - 添加拖拽状态检测，在拖拽过程中跳过不必要的事件处理

#### 3. 日期块导航问题修复
- **问题**: 日期块标签页点击没有响应
- **原因**: 使用了错误的导航方式，应该使用 `journal` 导航而不是 `block` 导航
- **修复**:
  - 检查标签是否为日期块（`tab.isJournal`）
  - 对于相对日期（今天/昨天/明天），使用 Orca 原生命令：
    - `orca.commands.invokeCommand('core.goToday')`
    - `orca.commands.invokeCommand('core.goYesterday')`
    - `orca.commands.invokeCommand('core.goTomorrow')`
  - 对于绝对日期，使用 `orca.nav.goTo("journal", { date: targetDate })`
  - 添加多层回退机制确保导航不会完全失败

#### 4. 拖拽后页面状态问题修复
- **问题**: 拖拽浮动窗后整个页面变成抓手无法点击
- **原因**: 拖拽结束后没有完全清理拖拽状态，影响了其他元素的交互
- **修复**:
  - 移除过激的事件处理（不再使用 `capture: true`）
  - 增强样式清理，重置所有可能被拖拽影响的样式属性
  - 添加强制重置机制，遍历所有元素重置被拖拽影响的样式
  - 恢复事件传播，确保其他元素能正常响应鼠标事件

#### 5. 日期格式错误修复
- **问题**: 出现 "Invalid time value" 错误
- **原因**: 传递给 `format` 函数的日期对象无效
- **修复**:
  - 添加日期有效性检查
  - 改进日期字符串解析，确保正确解析为UTC时间
  - 验证从块信息获取的日期有效性

### 🔧 技术改进

#### 事件处理优化
- 使用更精确的元素选择器
- 降低全局事件监听器优先级
- 添加拖拽状态感知机制
- 实现双重检查机制

#### 导航逻辑增强
- 支持 Orca 原生命令
- 使用正确的 `QueryJournalDate` 格式
- 实现多层回退机制
- 添加详细的调试信息

#### 样式管理改进
- 完整的拖拽状态清理
- 强制重置所有受影响元素
- 特别处理 Orca 原生元素
- 恢复所有交互功能

### 📝 代码变更统计
- 修改文件: `src/main.ts`
- 新增方法: `ensureClickableElements()`, `resetAllElements()`
- 优化方法: `switchToTab()`, `stopDrag()`, `handleClickEvent()`
- 增强调试: 添加详细的控制台日志

### 🎯 影响范围
- 侧边栏交互功能完全恢复
- 日期块导航功能正常工作
- 拖拽功能不再影响其他元素
- 整体用户体验显著提升

### ✅ 测试建议
1. 测试侧边栏的收藏/标签/页面按钮点击
2. 测试侧边栏/分屏的拖拽尺寸调整
3. 测试日期块标签页的点击导航
4. 测试拖拽浮动窗后的页面交互
5. 测试各种日期格式的标签页导航

---

**注意**: 此版本主要专注于修复交互问题，提升用户体验。建议在更新后清除浏览器缓存以确保所有更改生效。
