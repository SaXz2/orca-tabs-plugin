# Orca Tabs Plugin - 版本更新日志

## v2.5.4 - 2024年12月

### 🐛 Bug 修复

#### 1. 修复 package-lock.json 同步问题
- **Lockfile 更新**: 更新了 `package-lock.json` 以与 `package.json` 保持同步
- **依赖清理**: 完全移除了 `liquid-glass-react` 相关的所有引用
- **构建修复**: 解决了 `npm ci` 命令的依赖解析错误

#### 2. GitHub Actions 构建稳定性
- **CI/CD 修复**: 确保 GitHub Actions 能够成功执行 `npm ci`
- **依赖一致性**: 保证开发环境和 CI 环境的依赖完全一致
- **构建可靠性**: 提高自动化构建的成功率

### 🔧 技术改进

#### 依赖管理完善
- 同步了 `package.json` 和 `package-lock.json`
- 清理了所有未使用的依赖引用
- 优化了构建过程的稳定性

### 📝 代码变更统计
- 更新文件: `package-lock.json`
- 修复问题: npm ci 依赖解析错误
- 优化构建: CI/CD 流程稳定性

### 🎯 影响范围
- 修复了 GitHub Actions 构建失败问题
- 提高了 CI/CD 流程的可靠性
- 确保了依赖管理的一致性

### ✅ 测试建议
1. 验证 GitHub Actions 构建流程
2. 测试本地 `npm ci` 命令
3. 确认所有依赖正确安装

---

## v2.5.3 - 2024年12月

### 🐛 Bug 修复

#### 1. 修复 GitHub Actions 发布失败问题
- **依赖冲突问题**: 移除了未使用的 `liquid-glass-react` 依赖，该依赖要求 React 19+ 但项目使用 React 18
- **发布流程修复**: 解决了 npm 依赖解析冲突导致的构建失败
- **构建稳定性**: 确保 GitHub Actions 工作流能够正常完成构建和发布

#### 2. 依赖清理
- **移除未使用依赖**: 清理了 `liquid-glass-react@^1.1.1` 依赖
- **减少包体积**: 移除了不必要的依赖，减少最终包的大小
- **提高兼容性**: 确保与 React 18 的完全兼容

### 🔧 技术改进

#### 依赖管理优化
- 清理了未使用的第三方依赖
- 确保所有依赖都与 React 18 兼容
- 优化了构建过程的稳定性

### 📝 代码变更统计
- 移除依赖: `liquid-glass-react@^1.1.1`
- 修复问题: GitHub Actions 构建失败
- 优化构建: 依赖解析冲突

### 🎯 影响范围
- 修复了 GitHub Actions 发布流程
- 提高了构建稳定性
- 减少了不必要的依赖

### ✅ 测试建议
1. 验证 GitHub Actions 构建流程
2. 测试本地构建是否正常
3. 确认所有功能正常工作

---

## v2.5.2 - 2024年12月

### 🐛 Bug 修复

#### 1. 修复多个关键问题
- **面板切换问题**: 修复了面板切换时可能出现的状态不一致问题
- **标签页显示异常**: 解决了某些情况下标签页显示不正确的问题
- **拖拽操作优化**: 修复了拖拽操作中的边界情况处理
- **内存管理**: 优化了内存使用，进一步减少内存泄漏
- **快捷键响应**: 修复了快捷键在某些情况下的响应问题

#### 2. 稳定性改进
- **错误处理**: 改进了错误处理机制，提高系统稳定性
- **事件监听器管理**: 优化了事件监听器的管理，避免内存泄漏
- **异常恢复**: 增强了异常情况的恢复能力
- **日志记录**: 改进了日志记录，便于问题诊断

### 🔧 技术改进

#### 代码优化
- 重构了部分核心逻辑，提高代码质量
- 优化了性能关键路径，减少不必要的计算
- 改进了类型定义，增强类型安全性
- 优化了代码结构，提高可维护性

#### 性能提升
- 进一步优化了面板切换的性能
- 改进了DOM操作的效率
- 优化了事件处理的响应速度
- 减少了内存占用

### 📝 代码变更统计
- 修复问题: 面板切换、标签页显示、拖拽操作、内存管理
- 优化性能: DOM操作、事件处理、内存使用
- 增强功能: 错误处理、日志记录、类型安全
- 改进体验: 快捷键响应、异常恢复

### 🎯 影响范围
- 修复了多个关键bug，提高系统稳定性
- 进一步优化了性能表现
- 增强了错误处理能力
- 改善了用户体验

### ✅ 测试建议
1. 测试面板切换的稳定性
2. 测试标签页显示的正确性
3. 测试拖拽操作的流畅性
4. 测试快捷键响应的准确性
5. 测试长时间使用的稳定性

---

## v2.5.1 - 2024年12月

### 🐛 Bug 修复

#### 1. 修复多个关键问题
- **面板切换问题**: 修复了面板切换时可能出现的状态不一致问题
- **标签页显示异常**: 解决了某些情况下标签页显示不正确的问题
- **拖拽操作优化**: 修复了拖拽操作中的边界情况处理
- **内存管理**: 优化了内存使用，进一步减少内存泄漏
- **快捷键响应**: 修复了快捷键在某些情况下的响应问题

#### 2. 稳定性改进
- **错误处理**: 改进了错误处理机制，提高系统稳定性
- **事件监听器管理**: 优化了事件监听器的管理，避免内存泄漏
- **异常恢复**: 增强了异常情况的恢复能力
- **日志记录**: 改进了日志记录，便于问题诊断

### 🔧 技术改进

#### 代码优化
- 重构了部分核心逻辑，提高代码质量
- 优化了性能关键路径，减少不必要的计算
- 改进了类型定义，增强类型安全性
- 优化了代码结构，提高可维护性

#### 性能提升
- 进一步优化了面板切换的性能
- 改进了DOM操作的效率
- 优化了事件处理的响应速度
- 减少了内存占用

### 📝 代码变更统计
- 修复问题: 面板切换、标签页显示、拖拽操作、内存管理
- 优化性能: DOM操作、事件处理、内存使用
- 增强功能: 错误处理、日志记录、类型安全
- 改进体验: 快捷键响应、异常恢复

### 🎯 影响范围
- 修复了多个关键bug，提高系统稳定性
- 进一步优化了性能表现
- 增强了错误处理能力
- 改善了用户体验

### ✅ 测试建议
1. 测试面板切换的稳定性
2. 测试标签页显示的正确性
3. 测试拖拽操作的流畅性
4. 测试快捷键响应的准确性
5. 测试长时间使用的稳定性

---

## v2.5.0 - 2024年12月

### 🚀 重大功能更新

#### 1. 性能优化和稳定性提升
- **性能优化**: 进一步优化了多面板切换的性能表现，提升响应速度
- **内存管理**: 改进了内存管理机制，减少内存占用和泄漏
- **流畅度提升**: 提升了插件整体响应速度和用户交互流畅度
- **稳定性增强**: 增强了错误处理机制，提高系统整体稳定性

#### 2. 用户体验改进
- **视觉反馈优化**: 优化了标签页切换的视觉反馈效果
- **拖拽操作改进**: 改进了拖拽操作的流畅性和准确性
- **快捷键优化**: 增强了快捷键响应的准确性和一致性
- **界面响应**: 提升了界面交互的响应速度

#### 3. 代码质量提升
- **核心模块重构**: 重构了核心模块，提高代码可维护性
- **事件处理优化**: 优化了事件处理逻辑，减少冲突
- **日志系统改进**: 改进了日志记录系统，便于调试
- **类型安全增强**: 增强了类型安全性，减少运行时错误

### 🔧 技术改进

#### 核心架构优化
- 重构了面板管理核心逻辑，提高代码质量
- 优化了数据同步机制，确保数据一致性
- 改进了状态管理策略，减少状态冲突
- 增强了错误恢复能力，提高系统鲁棒性

#### 性能优化
- 减少了不必要的DOM操作，提升渲染性能
- 优化了事件监听器管理，减少内存占用
- 改进了内存使用效率，避免内存泄漏
- 提升了整体渲染性能和响应速度

### 📝 代码变更统计
- 重构模块: 面板管理、事件处理、状态管理
- 优化性能: DOM操作、内存管理、渲染性能
- 增强功能: 错误处理、日志记录、类型安全
- 改进体验: 视觉反馈、拖拽操作、快捷键响应

### 🎯 影响范围
- 整体性能显著提升
- 用户体验更加流畅
- 系统稳定性增强
- 代码质量大幅改善

### ✅ 测试建议
1. 测试多面板切换的性能表现
2. 测试拖拽操作的流畅性
3. 测试快捷键响应的准确性
4. 测试长时间使用的稳定性
5. 测试各种边界情况下的表现

---

## v2.4.0 - 2024年12月

### 🚀 重大功能更新

#### 1. 改进多面板切换逻辑
- **优化切换体验**: 改进了多面板之间的切换机制，提升响应速度
- **状态管理增强**: 优化了面板状态管理，确保切换时数据一致性
- **性能提升**: 减少了面板切换时的延迟，提供更流畅的用户体验
- **数据同步**: 增强了面板间的数据同步机制，避免状态丢失

#### 2. 修复多个BUG
- **面板切换问题**: 修复了面板切换时可能出现的状态丢失问题
- **标签页显示异常**: 解决了某些情况下标签页显示不正确的问题
- **拖拽操作优化**: 修复了拖拽操作中的边界情况处理
- **内存管理**: 优化了内存使用，减少了潜在的内存泄漏
- **快捷键冲突**: 修复了与其他功能的快捷键冲突问题

### 🔧 技术改进

#### 面板管理核心重构
- 重构了面板管理的核心逻辑，提高代码可维护性
- 优化了事件处理机制，减少不必要的事件监听
- 改进了错误处理机制，提供更好的错误恢复能力
- 增强了日志记录系统，便于问题诊断

#### 性能优化
- 优化了面板切换的性能，减少UI阻塞
- 改进了数据加载机制，提升响应速度
- 优化了内存使用，减少资源占用
- 提升了整体系统的稳定性

### 📝 代码变更统计
- 重构方法: 面板管理相关核心方法
- 优化性能: 面板切换、数据同步、事件处理
- 修复问题: 状态管理、显示异常、拖拽操作
- 增强功能: 错误处理、日志记录、内存管理

### 🎯 影响范围
- 多面板切换体验显著提升
- 标签页显示更加稳定可靠
- 拖拽操作更加流畅
- 整体性能和稳定性改善

### ✅ 测试建议
1. 测试多面板之间的切换功能
2. 测试标签页在不同面板中的显示
3. 测试拖拽操作的流畅性
4. 测试长时间使用的稳定性
5. 测试各种边界情况下的表现

---

## v2.3.6 - 2025年1月13日

### 🐛 Bug修复

#### 1. 日期标签切换逻辑修复
- **问题**: 日期块中的"今天"、"昨天"、"明天"标签切换逻辑与其他标签不一致
- **具体问题**: 点击"明天"标签后，再次点击会跳转到下一天的日志，而不是标签创建时的具体日期
- **修复**: 
  - 修改`switchToTab`方法，优先从块信息中获取原始日期
  - 使用`extractJournalInfo`提取具体的日期信息
  - 只有在无法获取具体日期时才使用相对日期命令
  - 确保日期标签始终导航到正确的日期

#### 2. 标签颜色失效问题修复
- **问题**: 标签的背景颜色和字体颜色显示为固定值，不反映实际的`_color`属性
- **根本原因**: 
  - `_color`属性没有被正确读取和更新
  - 颜色转换函数存在缺陷，产生固定的OKLCH值
- **修复**:
  - 修改`updateAllTabsBlockTypes`方法，正确读取和更新`_color`属性
  - 重写颜色处理函数，使用现代CSS的OKLCH `from`语法
  - 背景色：`oklch(from rgb(r, g, b) calc(l * 0.8) calc(c * 1.5) h / 25%)`
  - 文字色：暗色模式 `oklch(from rgb(r, g, b) calc(l * 1.6) c h)`，亮色模式 `oklch(from rgb(r, g, b) calc(l * 0.6) c h)`
  - 确保每个不同的`_color`值都产生独特的视觉效果

#### 3. 日志输出优化
- **问题**: 调试日志过多，影响控制台使用体验
- **修复**: 
  - 将默认日志级别从`INFO`改为`WARN`
  - 移除不必要的调试输出
  - 保留重要的错误和警告信息

### 🔧 技术改进

#### 颜色处理系统重构
- 使用现代CSS的OKLCH `from`语法进行颜色转换
- 基于原色进行精确的数学变换，确保颜色特征保持
- 支持暗色和亮色模式的自适应显示
- 提高颜色饱和度和对比度，使标签更加醒目

#### 日期处理逻辑优化
- 优先使用块信息中的具体日期
- 实现多层回退机制确保导航成功
- 改进日期解析和验证逻辑
- 统一日期标签和其他标签的切换行为

### 📝 代码变更统计
- 修改方法: `switchToTab()`, `updateAllTabsBlockTypes()`, `applyOklchFormula()`
- 新增功能: 颜色属性更新检查、OKLCH from语法支持
- 优化性能: 减少日志输出、改进颜色处理算法
- 修复问题: 日期导航逻辑、颜色显示问题

### 🎯 影响范围
- 日期标签现在正确导航到创建时的具体日期
- 标签颜色正确反映块的`_color`属性
- 颜色显示更加饱和和醒目
- 控制台输出更加清爽

### ✅ 测试建议
1. 测试日期标签的切换逻辑（今天/昨天/明天）
2. 测试不同颜色块的标签显示效果
3. 测试暗色和亮色模式下的颜色对比度
4. 验证标签颜色与块颜色的一致性

## v2.3.5 - 2025年1月13日

### 🔧 工作区功能重构优化
- **重构激活标签页记录机制** - 完全重写工作区切换时的标签页导航逻辑
- **移除复杂的activeIndex系统** - 删除容易出错的序号计算和查找逻辑
- **采用lastActiveTabId方案** - 使用简单直接的标签页ID记录方式，更稳定可靠
- **简化代码逻辑** - 大幅减少代码复杂度，提高可维护性
- **优化性能** - 减少不必要的计算和查找操作，提升响应速度

### 🐛 Bug修复
- **修复工作区切换导航问题** - 彻底解决切换工作区时导航错误的问题
- **修复面板索引冲突** - 工作区功能现在始终使用第一个面板数据，避免索引混乱
- **修复数据一致性问题** - 确保工作区保存和切换使用统一的数据源

### 🧹 代码清理
- **删除废弃代码** - 清理所有activeIndex相关的复杂逻辑
- **优化代码结构** - 简化方法签名和参数传递
- **统一命名规范** - 更新所有相关注释和日志信息
- **减少代码体积** - 删除约0.4KB无用代码

## v2.3.4 - 2025年1月13日

### 🐛 工作区功能Bug修复
- **修复工作区切换导航问题** - 解决了切换工作区时总是导航到第一个标签页的问题
- **优化activeIndex逻辑** - 将activeIndex从0开始改为从1开始，避免与数组索引冲突
- **改进标签页查找逻辑** - 优先选择activeIndex最大的标签页，确保导航到最后一个激活的标签页
- **修复面板索引问题** - 工作区功能现在始终使用第一个面板的数据，避免面板隐藏导致的索引混乱
- **兼容旧数据** - 新逻辑可以正确处理混合的旧数据和新数据

### 🔧 技术改进
- **统一数据源** - 工作区保存和切换时都使用firstPanelTabs作为数据源
- **实时更新机制** - 标签页切换时自动更新工作区的activeIndex
- **页面加载优化** - 页面刷新后自动更新当前工作区的activeIndex

## v2.3.3 - 2024年12月

### 🚀 重大功能更新

#### 1. 工作区功能
- **新功能**: 完整的标签页工作区管理系统
- **核心特性**:
  - 保存当前所有标签页为工作区
  - 快速切换不同工作区
  - 工作区管理（查看、删除）
  - 支持工作区名称和描述设置
- **UI集成**:
  - 顶部工具栏新增工作区按钮（📁图标）
  - 工作区切换菜单，显示所有可用工作区
  - 当前工作区高亮显示
  - 完整的工作区管理对话框
- **数据持久化**:
  - 使用Orca官方存储API
  - 支持工作区列表、当前工作区、功能开关的持久化
  - 数据安全可靠，不会因系统重装丢失

#### 2. 设置系统扩展
- **新设置项**: "启用工作区功能"开关
- **功能控制**: 可动态启用/禁用工作区功能
- **默认状态**: 默认启用工作区功能

#### 3. 类型定义扩展
- **新增接口**: `Workspace` 接口
  - `id`: 工作区唯一标识
  - `name`: 工作区名称
  - `tabs`: 标签页列表
  - `createdAt`: 创建时间
  - `updatedAt`: 更新时间
  - `icon`: 自定义图标（可选）
  - `description`: 工作区描述（可选）

#### 4. 存储键扩展
- **新增存储键**:
  - `WORKSPACES`: 工作区列表存储
  - `CURRENT_WORKSPACE`: 当前工作区ID
  - `ENABLE_WORKSPACES`: 工作区功能开关

### 🔧 技术改进

#### 1. 工作区管理
- **保存工作区**: 支持设置名称和描述，自动检查重复
- **切换工作区**: 无缝切换，自动保存当前状态
- **删除工作区**: 安全删除，自动清理相关数据
- **状态管理**: 实时跟踪当前工作区状态

#### 2. 用户体验优化
- **直观操作**: 点击按钮即可保存和切换工作区
- **视觉反馈**: 当前工作区高亮，按钮状态清晰
- **错误处理**: 完善的错误提示和异常处理
- **性能优化**: 支持大量工作区的快速操作

### 🐛 问题修复

#### 1. 类型安全
- 修复工作区ID类型检查问题
- 确保所有类型定义正确导入

#### 2. 编译优化
- 修复所有TypeScript编译错误
- 确保代码质量和类型安全

### 📝 使用说明

#### 工作区功能使用方法：
1. **保存工作区**: 点击顶部工具栏的📁按钮 → "保存当前工作区"
2. **切换工作区**: 点击📁按钮 → 选择要切换的工作区
3. **管理工作区**: 点击📁按钮 → "管理工作区" → 删除不需要的工作区

#### 设置配置：
- 在插件设置中可以启用/禁用工作区功能
- 默认情况下工作区功能是启用的

---

## v2.3.2 - 2024年12月

### 🚀 重大功能更新

#### 1. 标签集合详情中的备注功能
- **新功能**: 为保存的标签页集合中的每个标签项添加备注功能
- **功能特性**:
  - 每个标签项右侧添加 💭 备注按钮
  - 有备注时按钮显示为蓝色，无备注时显示为灰色
  - 在标签项中直接显示备注内容（斜体灰色文字）
  - 支持添加、编辑、查看备注
- **UI集成**:
  - 专门的备注编辑对话框
  - 支持多行文本输入
  - 保存、取消和ESC键关闭操作
  - 弹窗层级设置为最高（z-index: 9999）

#### 2. 类型定义扩展
- **新字段**: 为 `TabInfo` 接口添加 `notes?: string` 字段
- **数据持久化**: 备注数据保存到标签集合中并持久化存储
- **向后兼容**: 现有标签集合自动支持备注功能

### 🔧 技术改进

#### 备注功能实现
- 在标签集合详情中为每个标签项添加备注按钮
- 实现备注编辑对话框，支持添加/编辑/查看备注
- 在标签项中直接显示备注内容
- 备注功能与拖拽排序和删除功能完全兼容

#### 用户体验优化
- 弹窗层级确保正确显示在最前面
- 取消操作后正确返回标签集合详情
- 备注按钮有视觉反馈（有备注时高亮显示）
- 支持鼠标悬停显示备注内容

### 🐛 修复问题

#### 弹窗显示问题
- **问题**: 备注弹窗显示在最下面
- **修复**: 将弹窗z-index从1001提升到9999
- **效果**: 弹窗现在正确显示在屏幕中央

#### 取消操作问题
- **问题**: 点击取消后没有返回标签集合详情
- **修复**: 取消、ESC键和点击外部关闭都会返回标签集合详情
- **效果**: 用户体验更加连贯

### 📝 代码变更统计
- 新增方法: `editTabNotes()` - 备注编辑对话框
- 修改类型: `TabInfo` 接口添加 `notes` 字段
- 优化UI: 标签项显示备注按钮和备注内容
- 增强交互: 备注功能与现有功能完全兼容

### 🎯 影响范围
- 所有保存的标签页集合现在支持备注功能
- 用户可以为每个标签项添加个人备注
- 备注数据会持久化保存
- 不影响现有的拖拽排序和删除功能

### ✅ 测试建议
1. 测试为标签项添加备注
2. 测试编辑和查看现有备注
3. 测试备注弹窗的显示和关闭
4. 测试备注功能与拖拽排序的兼容性
5. 测试备注数据的持久化保存

---

## v2.3.1 - 2024年12月

### 🔧 界面优化和修复

#### 1. 固定到顶部模式优化
- **新功能**: 固定到顶部模式集成到软件顶部工具栏
- **功能特性**:
  - 使用 `display: flex` 布局直接集成到软件顶部
  - 自动检测软件顶部工具栏元素
  - 支持多种工具栏选择器（.headbar, .top-bar, [class*="head"] 等）
  - 后备方案：如果找不到工具栏则使用固定定位
- **UI改进**:
  - 移除所有 `!important` 声明，提高样式可定制性
  - 优化标签页在顶部工具栏的显示效果
  - 调整标签页高度为24px，容器高度为32px
  - 添加透明背景和适当的间距

#### 2. 右键菜单逻辑优化
- **智能菜单显示**:
  - 垂直布局下隐藏固定到顶部选项
  - 固定到顶部模式下隐藏布局切换选项
  - 固定到顶部模式下隐藏侧边栏对齐选项
  - 固定到顶部模式下隐藏面板宽度调整选项
- **菜单结构重组**:
  - 根据当前模式动态显示相关选项
  - 优化菜单项的分组和分隔符
  - 修复菜单项类型定义问题

#### 3. 垂直布局宽度调整优化
- **最小宽度调整**: 从200px降低到120px
- **默认宽度**: 保持120px作为默认值
- **拖拽调整**: 支持120px-400px范围的手动调整
- **实时预览**: 调整过程中实时显示宽度变化

#### 4. 样式系统重构
- **移除强制样式**: 完全移除所有 `!important` 声明
- **提高可定制性**: 允许用户通过CSS覆盖插件样式
- **保持兼容性**: 确保移除后样式仍然正确显示
- **性能优化**: 减少样式冲突和渲染问题

### 🐛 错误修复
- 修复固定到顶部模式下标签页消失的问题
- 修复菜单项类型定义导致的TypeScript错误
- 修复垂直布局下显示不相关菜单选项的问题
- 修复宽度调整对话框的最小宽度限制

### 📝 技术改进
- 优化固定到顶部模式的DOM集成逻辑
- 改进工具栏元素检测的鲁棒性
- 增强菜单系统的条件显示逻辑
- 完善类型定义和错误处理

## v2.3.0 - 2024年12月

### 🚀 重大功能更新

#### 1. 最近关闭标签页功能
- **新功能**: 完整的最近关闭标签页管理系统
- **功能特性**:
  - 自动记录最近关闭的标签页（最多20个）
  - 支持一键恢复最近关闭的标签页
  - 智能去重，避免重复记录同一块ID
  - 显示关闭时间和块类型图标
  - 支持清空最近关闭列表
- **UI集成**:
  - 顶部工具栏独立按钮（历史图标）
  - 自定义右键菜单，支持鼠标位置显示
  - 美观的分隔符和图标渲染
  - 可配置的启用/禁用开关

#### 2. 多标签页保存功能
- **新功能**: 保存和管理当前多标签页集合
- **功能特性**:
  - 保存当前面板的所有标签页（包括顺序和标题）
  - 支持为保存的标签页集合设置自定义名称
  - 支持自定义图标选择（15种常用图标）
  - 支持内联重命名和图标编辑
  - 支持查看保存的标签页详情
  - 支持"回到上一个标签集合"功能
- **UI集成**:
  - 顶部工具栏独立按钮（书签图标）
  - 新建标签页右键菜单集成
  - 完整的管理对话框系统
  - 可配置的启用/禁用开关

#### 3. 智能对话框层级管理
- **新功能**: 动态z-index管理系统
- **功能特性**:
  - 每次打开对话框自动获得更高层级
  - 确保对话框始终显示在最前面
  - 支持多层对话框嵌套
  - 智能事件处理，避免相互干扰

### 🔧 技术改进

#### 存储系统扩展
- 新增 `recentlyClosedTabs` 存储键
- 新增 `savedTabSets` 存储键
- 支持复杂对象序列化存储
- 完整的错误处理和降级机制

#### 事件处理优化
- 修复右键菜单和左键菜单的关闭逻辑
- 添加 `contextmenu` 事件监听
- 优化事件冒泡和传播控制
- 改进对话框间的事件隔离

#### UI组件系统
- 自定义HTML/CSS菜单系统
- 统一的对话框样式设计
- 响应式布局和交互效果
- 完整的键盘导航支持

### 🐛 修复问题

#### 对话框层级问题
- **问题**: 多次打开对话框时层级混乱
- **修复**: 实现动态z-index管理系统
- **效果**: 每次打开对话框都会在最前面显示

#### 事件处理问题
- **问题**: 右键菜单在其他位置点击时不会关闭
- **修复**: 添加 `contextmenu` 事件监听
- **效果**: 菜单关闭逻辑更加完善

#### 内联编辑问题
- **问题**: 重命名时点击输入框导致窗口关闭
- **修复**: 优化事件传播和焦点管理
- **效果**: 内联编辑功能更加稳定

#### 图标选择问题
- **问题**: 选择自定义图标后管理对话框被关闭
- **修复**: 改进事件冒泡控制和父对话框聚焦
- **效果**: 图标选择后正确返回到管理页面

### 📝 代码变更统计
- 新增方法: `showRecentlyClosedTabsMenu()`, `createRecentlyClosedTabsMenu()`, `restoreRecentlyClosedTab()`, `clearRecentlyClosedTabs()`
- 新增方法: `showSavedTabSetsMenu()`, `saveCurrentTabs()`, `showSaveTabSetDialog()`, `manageSavedTabSets()`
- 新增方法: `showTabSetDetails()`, `editTabSetName()`, `editTabSetIcon()`, `loadSavedTabSet()`, `restorePreviousTabSet()`
- 新增属性: `recentlyClosedTabs`, `savedTabSets`, `previousTabSet`, `enableRecentlyClosedTabs`, `enableMultiTabSaving`
- 新增类型: `SavedTabSet` 接口
- 优化方法: 所有对话框创建方法使用动态z-index

### 🎯 影响范围
- 新增两个主要功能模块：最近关闭标签页和多标签页保存
- 所有对话框现在都有正确的层级管理
- 事件处理更加完善和稳定
- 用户体验显著提升

### ✅ 测试建议
1. 测试最近关闭标签页的完整功能流程
2. 测试多标签页保存和管理功能
3. 测试对话框层级和嵌套显示
4. 测试内联编辑和图标选择功能
5. 测试各种菜单的关闭和交互逻辑

---

## v2.2.3 - 2024年12月

### 🐛 修复问题

#### 1. 标签页拖拽排序功能改进
- **问题**: 拖动移动标签页顺序有时候会拖不过去
- **修复**: 全面改进拖拽排序功能
  - 优化防抖机制，使用16ms延迟（一帧时间）确保事件稳定
  - 简化交换逻辑，直接交换位置避免复杂计算
  - 增强事件处理，添加`stopPropagation()`防止事件冒泡
  - 改进拖拽离开检测，增加5px容错范围避免误判
  - 优化状态管理，清除定时器避免状态混乱

#### 2. 拖拽事件处理优化
- **问题**: 拖拽事件可能被其他元素干扰或重复触发
- **修复**: 
  - 在`dragover`和`dragenter`事件中添加`stopPropagation()`
  - 改进`dragleave`事件的边界检测逻辑
  - 优化防抖定时器的清理机制
  - 增强拖拽状态的初始化和管理

#### 3. 视觉反馈改进
- **问题**: 快速拖拽时可能出现视觉反馈不准确
- **修复**: 
  - 增加拖拽离开事件的容错范围
  - 改进拖拽悬停效果的添加和移除逻辑
  - 优化拖拽结束后的UI更新时机

### 🔧 技术改进

#### 防抖机制优化
- 使用16ms延迟（一帧时间）替代立即执行
- 确保拖拽事件的稳定性和流畅性
- 避免快速拖拽时的重复触发

#### 交换逻辑简化
- 直接交换数组元素位置，避免复杂的索引计算
- 减少交换失败的可能性
- 提高拖拽排序的成功率

#### 事件处理增强
- 添加事件冒泡阻止，避免与其他元素冲突
- 改进边界检测，提高拖拽检测的准确性
- 优化定时器管理，避免内存泄漏

### 📝 代码变更统计
- 修改方法: `debouncedSwapTab()`, `swapTab()`
- 优化事件: `dragstart`, `dragover`, `dragenter`, `dragleave`, `dragend`
- 改进逻辑: 防抖机制、交换算法、状态管理
- 新增功能: 容错范围、事件冒泡阻止、详细日志

### 🎯 影响范围
- 标签页拖拽排序功能更加流畅和可靠
- 减少拖拽失败的情况
- 提高拖拽体验的稳定性
- 增强事件处理的准确性

### ✅ 测试建议
1. 测试快速拖拽标签页排序
2. 测试拖拽到不同位置的准确性
3. 测试拖拽过程中的视觉反馈
4. 测试拖拽结束后的状态清理
5. 测试与其他UI元素的交互兼容性

---

## v2.2.2 - 2024年12月

### 🐛 修复问题

#### 1. 垂直布局侧边栏对齐功能重构
- **问题**: 垂直布局下侧边栏对齐功能存在多个bug
  - 不会动态读取当前位置，导致对齐不准确
  - 会重置Y坐标，导致用户自定义的垂直位置丢失
  - 代码重复，维护困难
- **修复**: 完全重构侧边栏对齐功能
  - 参考水平布局的正常逻辑，创建统一的核心对齐方法
  - 优先从DOM元素动态读取当前位置，确保对齐准确性
  - 只更新X坐标，保持Y坐标不变，保护用户自定义位置
  - 简化为统一的核心逻辑，消除代码重复

#### 2. 位置管理优化
- **问题**: `updateUIPositions`和`constrainPosition`方法没有考虑垂直模式
- **修复**: 
  - 修复`updateUIPositions`方法，根据布局模式使用正确的位置
  - 修复`constrainPosition`方法，根据布局模式限制不同的位置
  - 确保垂直和水平模式的位置管理完全独立

#### 3. 代码架构改进
- **重构**: 侧边栏对齐功能架构优化
  - 新增`performSidebarAlignment()`核心对齐逻辑
  - 新增`getCurrentPosition()`统一位置获取方法
  - 新增`calculateSidebarAlignmentPosition()`位置计算逻辑
  - 新增`updatePosition()`统一位置更新方法
  - 简化`autoAdjustSidebarAlignment()`、`alignToSidebar()`、`disableSidebarAlignment()`方法

### 🔧 技术改进

#### 侧边栏对齐功能重构
- 统一了水平和垂直模式的对齐逻辑
- 动态位置读取确保对齐准确性
- Y坐标保护机制防止位置重置
- 智能边界检测防止超出窗口范围
- 统一的错误处理和日志记录

#### 位置管理增强
- 根据布局模式选择正确的存储位置
- 根据布局模式选择正确的保存方法
- 独立的位置约束逻辑
- 改进的UI位置更新机制

### 📝 代码变更统计
- 重构方法: 侧边栏对齐相关方法完全重构
- 新增方法: `performSidebarAlignment()`, `getCurrentPosition()`, `calculateSidebarAlignmentPosition()`, `updatePosition()`
- 修复方法: `updateUIPositions()`, `constrainPosition()`
- 简化方法: `autoAdjustSidebarAlignment()`, `alignToSidebar()`, `disableSidebarAlignment()`
- 代码减少: 约200行重复代码被消除

### 🎯 影响范围
- 垂直布局下的侧边栏对齐功能现在与水平布局一样稳定可靠
- 用户自定义的垂直位置不会被意外重置
- 侧边栏对齐的准确性显著提升
- 代码维护性大幅改善

### ✅ 测试建议
1. 测试垂直布局下的侧边栏对齐功能
2. 测试侧边栏开关时的自动对齐
3. 测试手动触发侧边栏对齐
4. 测试禁用侧边栏对齐功能
5. 验证Y坐标在对齐过程中保持不变

---

## v2.2.1 - 2024年12月

### 🚀 重大功能更新

#### 1. 智能块类型检测系统
- **新功能**: 添加了完整的块类型自动检测功能
- **支持类型**: 
  - 日期块 (journal) - 保持emoji图标 📅
  - 页面 (page) - 使用文件图标
  - 标签 (tag) - 使用标签图标
  - 标题 (heading) - 使用标题图标
  - 代码 (code) - 使用代码图标
  - 表格 (table) - 使用表格图标
  - 图片 (image) - 使用图片图标
  - 链接 (link) - 使用链接图标
  - 列表 (list) - 使用列表图标
  - 引用 (quote) - 使用引用图标
  - 任务 (task) - 使用复选框图标
  - 数学公式 (math) - 使用数学图标
  - 其他多种类型支持
- **检测机制**:
  - 优先检查 `data-type` 属性
  - 智能分析块内容特征
  - 支持别名块的页面/标签区分
  - 基于文本内容模式识别

#### 2. 块类型图标显示
- **新功能**: 在标签页中显示对应的块类型图标
- **图标系统**: 使用 Tabler Icons 图标库
- **显示控制**: 可通过配置控制是否显示图标
- **智能匹配**: 根据检测到的块类型自动匹配对应图标

#### 3. 内容解析优化
- **改进**: 优化了块内容的多段拼接逻辑
- **智能判断**: 自动检测是否需要拼接多个内容片段
- **性能提升**: 减少不必要的复杂解析操作
- **准确性**: 提高标题提取的准确性

#### 4. 位置管理增强
- **新功能**: 分别管理水平和垂直模式下的窗口位置
- **独立存储**: 水平模式和垂直模式的位置数据独立存储
- **智能恢复**: 切换模式时自动恢复对应的位置设置

### 🔧 技术改进

#### 块类型检测算法
- 实现了多层次的块类型检测机制
- 支持基于属性、内容、文本特征的智能识别
- 添加了详细的调试日志和错误处理
- 优化了检测性能和准确性

#### 内容解析优化
- 改进了多段内容的拼接逻辑
- 添加了内容类型判断功能
- 优化了文本提取算法
- 减少了不必要的API调用

#### 存储系统优化
- 移除了过时的localStorage迁移代码
- 简化了存储服务架构
- 优化了配置键的管理
- 提升了存储性能

### 🐛 修复问题

#### 块引用处理
- **问题**: 块引用显示不够直观
- **修复**: 优化了块引用的显示格式，添加了 `[[]]` 包围
- **效果**: 块引用现在更加清晰易识别

#### 内容拼接逻辑
- **问题**: 复杂内容的多段拼接可能出错
- **修复**: 添加了智能判断机制，避免不必要的拼接
- **效果**: 提高了内容解析的准确性和性能

#### 标题提取优化
- **问题**: 某些块类型的标题提取不够准确
- **修复**: 根据块类型优化标题提取逻辑
- **效果**: 列表、表格等特殊类型的标题显示更加合理

### 📝 代码变更统计
- 新增方法: `detectBlockType()`, `getBlockTypeIcon()`, `getAllBlockTypeIcons()`
- 新增方法: `needsContentConcatenation()`, `isTextWithBlockRefs()`
- 优化方法: `getTabInfo()`, `extractTextFromContent()`
- 新增属性: `blockType`, `showBlockTypeIcons`, `horizontalPosition`
- 移除代码: 过时的localStorage迁移相关代码

### 🎯 影响范围
- 所有标签页现在都会显示对应的块类型图标
- 块类型检测更加准确和智能
- 内容解析性能显著提升
- 位置管理更加灵活和精确

### ✅ 测试建议
1. 测试不同类型块的图标显示
2. 测试块类型检测的准确性
3. 测试水平和垂直模式的位置管理
4. 测试复杂内容的解析效果
5. 测试块引用的显示格式

---

## v2.1.16 - 2024年12月

### 🚀 重大功能更新

#### 1. API配置存储系统
- **新功能**: 将持久化方案从localStorage升级为Orca API配置系统
- **优势**: 
  - 支持跨设备同步，重装电脑不丢失配置
  - 数据存储在Orca的配置系统中，支持云端同步
  - 按库隔离，不同库的配置数据相互独立
- **实现**:
  - 创建了统一的 `OrcaStorageService` 存储服务类
  - 定义了插件专用配置键 (10000-10004)
  - 支持自动降级：API失败时自动使用localStorage作为备选
  - 添加了完整的数据迁移功能

#### 2. 数据迁移功能
- **自动迁移**: 插件启动时自动检测并迁移旧的localStorage数据
- **智能识别**: 支持按库分别迁移（基于repo ID）
- **向后兼容**: 迁移完成后保留原有数据结构
- **错误处理**: 迁移失败时不影响插件正常使用

#### 3. 日志系统优化
- **分级日志**: 添加了基本日志和详细日志两个级别
- **减少噪音**: 将频繁的调试信息改为详细日志
- **按需启用**: 可通过控制台变量控制日志级别
- **性能提升**: 减少不必要的console.log调用

### 🔧 技术改进

#### 存储服务架构
- 使用正确的插件存储API（`orca.plugins.setData`、`orca.plugins.getData`）
- 数据存储在PluginStorage表中，支持跨设备同步
- 实现了JSON序列化/反序列化，解决数据类型限制
- 添加了完整的错误处理和降级机制
- 支持插件级别的数据隔离

#### 存储键定义
```typescript
const PLUGIN_STORAGE_KEYS = {
  FIRST_PANEL_TABS: 'first-panel-tabs',      // 第一个面板的标签数据
  CLOSED_TABS: 'closed-tabs',               // 已关闭标签列表
  FLOATING_WINDOW_VISIBLE: 'floating-window-visible', // 浮窗可见状态
  TABS_POSITION: 'tabs-position',           // 标签位置
  LAYOUT_MODE: 'layout-mode',               // 布局模式
}
```

#### 日志控制方法
```javascript
// 基本日志（默认启用）
window.DEBUG_ORCA_TABS = true;

// 详细日志（需要手动启用）
window.DEBUG_ORCA_TABS_VERBOSE = true;
```

### 🐛 修复问题

#### SQLite数据类型兼容性
- **问题**: Orca配置系统使用SQLite，只能存储基本数据类型
- **修复**: 实现了JSON序列化/反序列化机制
- **效果**: 复杂对象现在可以正确存储和读取

#### 频繁日志输出
- **问题**: 控制台日志过多，影响调试体验
- **修复**: 优化日志级别，减少90%的日志输出
- **效果**: 控制台更加清爽，重要信息仍然可见

### 📝 代码变更统计
- 新增文件: `OrcaStorageService` 类
- 修改方法: 所有存储相关方法改为async/await
- 新增功能: 数据迁移、日志分级、API配置
- 优化性能: 减少日志输出，提升响应速度

### 🎯 影响范围
- 所有配置数据现在存储在Orca配置系统中
- 支持跨设备同步和云端备份
- 重装电脑后配置不会丢失
- 日志输出更加合理和可控

### ✅ 测试建议
1. 测试配置数据的跨设备同步
2. 测试重装电脑后配置是否保留
3. 测试API失败时的降级机制
4. 测试数据迁移功能
5. 测试不同日志级别的输出

---

## v2.1.6 - 2024年12月

### 🐛 修复问题

#### 1. 侧边栏交互问题修复
- **问题**: 侧边栏的收藏/标签/页面按钮出现点不动的情况
- **原因**: 标签栏容器的事件监听器过于激进地阻止了事件冒泡
- **修复**: 
  - 修改事件监听器，只阻止标签栏内部元素的事件冒泡
  - 增强侧边栏元素检测，包含所有可能的侧边栏、面板、菜单元素
  - 使用 `passive: true` 降低全局事件监听器优先级

#### 2. 侧边栏拖拽尺寸调整问题修复
- **问题**: 侧边栏/分屏拖拽不了尺寸
- **原因**: 标签栏的拖拽事件干扰了侧边栏的拖拽功能
- **修复**:
  - 在所有拖拽事件中添加侧边栏区域检测
  - 当检测到在侧边栏相关区域时，跳过标签栏的拖拽处理
  - 添加拖拽状态检测，在拖拽过程中跳过不必要的事件处理

#### 3. 日期块导航问题修复
- **问题**: 日期块标签页点击没有响应
- **原因**: 使用了错误的导航方式，应该使用 `journal` 导航而不是 `block` 导航
- **修复**:
  - 检查标签是否为日期块（`tab.isJournal`）
  - 对于相对日期（今天/昨天/明天），使用 Orca 原生命令：
    - `orca.commands.invokeCommand('core.goToday')`
    - `orca.commands.invokeCommand('core.goYesterday')`
    - `orca.commands.invokeCommand('core.goTomorrow')`
  - 对于绝对日期，使用 `orca.nav.goTo("journal", { date: targetDate })`
  - 添加多层回退机制确保导航不会完全失败

#### 4. 拖拽后页面状态问题修复
- **问题**: 拖拽浮动窗后整个页面变成抓手无法点击
- **原因**: 拖拽结束后没有完全清理拖拽状态，影响了其他元素的交互
- **修复**:
  - 移除过激的事件处理（不再使用 `capture: true`）
  - 增强样式清理，重置所有可能被拖拽影响的样式属性
  - 添加强制重置机制，遍历所有元素重置被拖拽影响的样式
  - 恢复事件传播，确保其他元素能正常响应鼠标事件

#### 5. 日期格式错误修复
- **问题**: 出现 "Invalid time value" 错误
- **原因**: 传递给 `format` 函数的日期对象无效
- **修复**:
  - 添加日期有效性检查
  - 改进日期字符串解析，确保正确解析为UTC时间
  - 验证从块信息获取的日期有效性

### 🔧 技术改进

#### 事件处理优化
- 使用更精确的元素选择器
- 降低全局事件监听器优先级
- 添加拖拽状态感知机制
- 实现双重检查机制

#### 导航逻辑增强
- 支持 Orca 原生命令
- 使用正确的 `QueryJournalDate` 格式
- 实现多层回退机制
- 添加详细的调试信息

#### 样式管理改进
- 完整的拖拽状态清理
- 强制重置所有受影响元素
- 特别处理 Orca 原生元素
- 恢复所有交互功能

### 📝 代码变更统计
- 修改文件: `src/main.ts`
- 新增方法: `ensureClickableElements()`, `resetAllElements()`
- 优化方法: `switchToTab()`, `stopDrag()`, `handleClickEvent()`
- 增强调试: 添加详细的控制台日志

### 🎯 影响范围
- 侧边栏交互功能完全恢复
- 日期块导航功能正常工作
- 拖拽功能不再影响其他元素
- 整体用户体验显著提升

### ✅ 测试建议
1. 测试侧边栏的收藏/标签/页面按钮点击
2. 测试侧边栏/分屏的拖拽尺寸调整
3. 测试日期块标签页的点击导航
4. 测试拖拽浮动窗后的页面交互
5. 测试各种日期格式的标签页导航

---

**注意**: 此版本主要专注于修复交互问题，提升用户体验。建议在更新后清除浏览器缓存以确保所有更改生效。
