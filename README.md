# Orca Tabs Plugin

为 Orca Note 提供浏览器式标签页功能，智能读取所有活跃编辑器块并显示为可拖拽的悬浮标签页，方便在不同页面间快速切换。

> **默认新建标签页为块ID:1,留空会出现BUG。**


## 版本历史

### v2.3.0
- 🚀 **最近关闭标签页功能** - 自动记录最近关闭的标签页（最多20个），支持一键恢复和智能去重
- 💾 **多标签页保存功能** - 保存当前多标签页集合，支持自定义名称、图标选择、内联编辑
- 🎯 **智能对话框层级管理** - 动态z-index管理系统，确保对话框始终显示在最前面
- 🔧 **事件处理优化** - 修复菜单关闭逻辑，添加contextmenu事件监听，完善事件传播控制
- 🎨 **UI组件系统** - 自定义HTML/CSS菜单系统，统一对话框样式设计，响应式布局
- 📊 **存储系统扩展** - 新增recentlyClosedTabs和savedTabSets存储，支持复杂对象序列化
- 🐛 **修复多个问题** - 对话框层级、内联编辑、图标选择等问题的全面修复

### v2.2.1
- 🚀 **智能块类型检测系统** - 新增完整的块类型自动检测功能，支持20+种块类型识别
- 🎨 **块类型图标显示** - 在标签页中显示对应的块类型图标，使用Tabler Icons图标库
- 🔧 **内容解析优化** - 优化块内容的多段拼接逻辑，提升标题提取准确性
- 📍 **位置管理增强** - 分别管理水平和垂直模式下的窗口位置，支持独立存储
- 🗑️ **存储系统优化** - 移除过时的localStorage迁移代码，简化存储架构
- 🔗 **块引用显示优化** - 优化块引用的显示格式，添加[[]]包围
- ⚡ **性能提升** - 改进多段内容拼接逻辑，减少不必要的复杂解析操作

### v2.1.6
- 🐛 **修复侧边栏交互问题** - 解决侧边栏收藏/标签/页面按钮点不动的问题
- 🐛 **修复侧边栏拖拽问题** - 解决侧边栏/分屏拖拽尺寸调整失效的问题
- 🐛 **修复日期块导航问题** - 解决日期块标签页点击无响应的问题，使用正确的 Orca 原生导航方式
- 🐛 **修复拖拽状态问题** - 解决拖拽浮动窗后整个页面变成抓手无法点击的问题
- 🔧 **优化事件处理机制** - 使用更精确的元素选择器和更低的事件优先级
- 🔧 **增强导航逻辑** - 支持 Orca 原生命令和正确的日期格式
- 🔧 **完善样式管理** - 完整的拖拽状态清理和元素重置机制

### v2.1.5
- 🐛 **修复固定标签页被替换问题** - 在固定标签页上打开新标签时，新标签会正确插入到固定标签后面而不是替换固定标签
- 🔧 **优化标签插入逻辑** - 改进了 `checkFirstPanelBlocks` 和 `addTabToPanel` 方法中的标签插入逻辑
- 🛡️ **增强固定标签保护** - 确保固定标签永远不会被意外替换，保持标签栏的稳定性

### v2.1.4
- 基础功能完善，包含标签固定、拖拽、关闭等核心功能

## 功能特性

### 核心功能
- 🏷️ **智能标签读取** - 自动读取所有 `.orca-panel` 面板下的编辑器块，生成对应标签
- 🎯 **智能块类型检测** - 自动识别20+种块类型（页面、标签、代码、表格、图片等），并显示对应图标
- 🎨 **个性化样式** - 支持读取块的 `_color` 和 `_icon` 属性，自定义标签外观和字体加粗
- 🖱️ **可拖拽悬浮栏** - 悬浮标签栏可自由拖拽定位，避免与窗口拖拽功能冲突
- 💾 **位置持久化** - 标签栏位置自动保存，支持水平和垂直模式独立位置存储
- 🔍 **背景模糊效果** - 2px 模糊强度的毛玻璃效果，提升视觉体验
- 📊 **智能数量控制** - 根据 `orca.state.settings[13]` 设置控制最大标签数量
- 🔄 **实时更新** - 监听DOM变化，自动更新标签状态

### 标签管理功能
- 📌 **标签固定功能** - 支持固定标签，固定标签会置顶显示且不会被"关闭全部"操作影响，也不会被新标签页替换
- 🖱️ **多种关闭方式** - 支持中键点击、右键菜单等多种关闭标签方式
- 🔗 **智能内容解析** - 优化块内容解析，提升标题提取准确性和性能

### 高级功能 (v2.3.0)
- 📚 **最近关闭标签页** - 自动记录最近关闭的标签页（最多20个），支持一键恢复和智能去重
- 💾 **多标签页保存** - 保存当前多标签页集合，支持自定义名称、图标选择、内联编辑
- 🔄 **回到上一个标签集合** - 支持在保存的标签页集合间快速切换，防止误操作
- 🎨 **自定义图标系统** - 15种常用图标选择，支持内联编辑和实时预览
- 🎯 **智能对话框管理** - 动态z-index管理系统，确保对话框始终显示在最前面
- ⚙️ **可配置开关** - 所有高级功能都支持在插件设置中启用/禁用

## 安装

```bash
npm install
npm run build
```

构建完成后，将 `dist/index.js` 文件复制到 Orca Note 的插件目录，

> 💡 提示：安装后可能需要重启 Orca Note 应用才能生效

> 💡 提示：右侧有编译好的



## 使用

插件启动后会自动检测并创建悬浮标签栏：

1. **自动检测面板** - 读取 `section#main` 下 `.orca-panels-row` 中的所有 `.orca-panel` 面板
2. **提取编辑器块** - 从每个面板的 `.orca-hideable` 中提取 `.orca-block-editor` 的 `data-block-id`
3. **智能命名** - 优先使用 `BlockAlias`，其次是 `_repr` 值（日期块），最后使用 `BlockProperty` 内容
4. **个性化样式** - 读取 `_color` 和 `_icon` 属性，设置60%透明背景色和700字重
5. **拖拽定位** - 通过左侧拖拽手柄移动标签栏，位置自动保存
6. **快速切换** - 点击标签直接跳转到对应的块和面板

### 标签固定功能

- **固定标签**：双击标签可以切换标签的固定状态
- **固定标识**：固定标签会显示 📌 图标，并自动排序到标签栏最前面
- **保护机制**：固定标签不会被"关闭全部"操作影响，也不会被新标签页替换
- **智能插入**：在固定标签上打开新标签时，新标签会自动插入到固定标签的后面
- **手动关闭**：固定标签需要手动关闭，确保重要标签不会意外丢失

### 关闭标签功能

- **中键点击**：使用鼠标中键点击标签可以关闭该标签
- **右键菜单**：右键点击标签显示上下文菜单，包含：
  - 固定/取消固定标签
  - 关闭标签
  - 关闭其他标签
  - 关闭全部标签
- **保护限制**：只有一个标签时无法关闭，固定标签默认不可关闭

### 最近关闭标签页功能 (v2.3.0)

- **自动记录**：关闭标签时自动记录到最近关闭列表（最多20个）
- **智能去重**：同一块ID只保留最新的关闭记录
- **一键恢复**：点击顶部工具栏的历史按钮，选择要恢复的标签页
- **时间显示**：显示标签页的关闭时间，方便识别
- **清空功能**：支持清空整个最近关闭列表
- **配置开关**：可在插件设置中启用/禁用此功能

### 多标签页保存功能 (v2.3.0)

- **保存集合**：右键新建标签页按钮，选择"保存当前标签页"
- **自定义命名**：为保存的标签页集合设置有意义的名称
- **图标选择**：从15种常用图标中选择，或使用默认图标
- **内联编辑**：直接在管理界面中重命名和更换图标
- **查看详情**：查看保存的标签页集合包含哪些标签
- **快速切换**：点击顶部工具栏的书签按钮，快速加载保存的标签页集合
- **回到上一个**：支持回到上一个标签页集合，防止误操作
- **配置开关**：可在插件设置中启用/禁用此功能

## 块属性支持

- `_color` - 设置标签背景色（60%透明度）和文字颜色，需要 `type=1`
- `_icon` - 设置标签图标（emoji或文本），需要 `type=1`

> 注意：只有同时具有 `_color` 和 `_icon` 属性的标签才会应用加粗字体（font-weight: 700）

## 打开方式

- 块菜单新建标签页
- 块引用 `Ctrl+左键` 在新标签页打开

## 技术实现

### 数据读取流程
1. 扫描 `.orca-panel` 获取 `data-panel-id`
2. 按用户操作顺序读取 `.orca-hideable` 下的编辑器块
3. 提取 `data-block-id` 并限制在最大标签数量内
4. 调用后端API获取块信息、别名、属性等

### 标签命名优先级
1. **日期块** - 日期块的格式化显示（最高优先级）
2. **BlockAlias** - 块别名
3. **BlockProperty** - content中的文本内容
4. **块类型优化** - 根据块类型优化标题提取（如列表提取第一行，表格提取标题等）

### 样式系统
- 默认：浅灰背景，普通字重
- 有色彩：自定义背景色（60%透明），匹配文字颜色，加粗字体
- 背景模糊：2px模糊强度的毛玻璃效果
- 块类型图标：使用Tabler Icons图标库，根据块类型自动显示对应图标

### 支持的块类型
- 📅 **日期块** (journal) - 保持emoji图标
- 📄 **页面** (page) - 文件图标
- 🏷️ **标签** (tag) - 标签图标
- 📝 **标题** (heading) - 标题图标
- 💻 **代码** (code) - 代码图标
- 📊 **表格** (table) - 表格图标
- 🖼️ **图片** (image) - 图片图标
- 🔗 **链接** (link) - 链接图标
- 📋 **列表** (list) - 列表图标
- 💬 **引用** (quote) - 引用图标
- ✅ **任务** (task) - 复选框图标
- 🧮 **数学公式** (math) - 数学图标
- 以及其他多种类型...


## 常见问题

**Q: 标签栏什么时候会显示？**
A: 当检测到活跃的编辑器块时自动显示，会实时监听DOM变化

**Q: 标签数量有限制吗？**
A: 是的，受 **缓存页最大数量** 设置控制

**Q: 标签栏位置会丢失吗？**
A: 不会，位置保存在 localStorage 中，应用重启后自动恢复

**Q: 支持哪些标签内容？**
A: 支持普通文本块、日期块（journal类型）、带别名的块等

**Q: 标签顺序是怎么确定的？**
A: 按用户操作顺序，新点击的块会插入到最前面而不是尾部

**Q: 如何固定标签？**
A: 双击标签可以切换标签的固定状态

**Q: 如何关闭标签？**
A: 可以使用中键点击或右键菜单来关闭标签

**Q: 为什么有些标签无法关闭？**
A: 固定标签默认不可关闭，只有一个标签时也无法关闭

**Q: 在固定标签上打开新标签会发生什么？**
A: 新标签会自动插入到固定标签的后面，保持固定标签的位置和状态不变

**Q: 块类型图标是如何显示的？**
A: 插件会自动检测每个块的类型，并在标签页中显示对应的图标，让标签页更加直观易识别

**Q: 支持哪些块类型？**
A: 支持20+种块类型，包括页面、标签、代码、表格、图片、链接、列表、引用、任务、数学公式等，每种类型都有对应的图标

**Q: 块类型检测准确吗？**
A: 使用多层次的检测机制，包括属性检查、内容分析、文本特征识别等，确保检测的准确性

**Q: 最近关闭标签页功能如何使用？**
A: 关闭标签时会自动记录，点击顶部工具栏的历史按钮可以查看和恢复最近关闭的标签页

**Q: 如何保存当前的多标签页集合？**
A: 右键点击新建标签页按钮，选择"保存当前标签页"，然后输入名称即可保存

**Q: 保存的标签页集合可以重命名吗？**
A: 可以，在管理界面中点击标签页集合的名称即可进行内联编辑重命名

**Q: 如何更换保存的标签页集合的图标？**
A: 在管理界面中点击标签页集合的图标，会弹出图标选择器，选择喜欢的图标即可

**Q: 如何查看保存的标签页集合包含哪些标签？**
A: 在管理界面中点击"查看"按钮，可以查看该集合包含的所有标签详情

**Q: 如何快速切换不同的标签页集合？**
A: 点击顶部工具栏的书签按钮，选择要加载的标签页集合即可快速切换

**Q: 如果误操作切换了标签页集合怎么办？**
A: 可以使用"回到上一个标签集合"功能，快速恢复到之前的标签页状态

**Q: 这些高级功能可以关闭吗？**
A: 可以，在插件设置中可以分别启用/禁用最近关闭标签页和多标签页保存功能



