# Orca Tabs Plugin

为 Orca Note 提供浏览器式标签页功能，智能读取所有活跃编辑器块并显示为可拖拽的悬浮标签页，方便在不同页面间快速切换。

## 版本历史

### v2.1.5 (2024-09-10)
- 🐛 **修复固定标签页被替换问题** - 在固定标签页上打开新标签时，新标签会正确插入到固定标签后面而不是替换固定标签
- 🔧 **优化标签插入逻辑** - 改进了 `checkFirstPanelBlocks` 和 `addTabToPanel` 方法中的标签插入逻辑
- 🛡️ **增强固定标签保护** - 确保固定标签永远不会被意外替换，保持标签栏的稳定性

### v2.1.4
- 基础功能完善，包含标签固定、拖拽、关闭等核心功能

## 功能特性

- 🏷️ **智能标签读取** - 自动读取所有 `.orca-panel` 面板下的编辑器块，生成对应标签
- 🎨 **个性化样式** - 支持读取块的 `_color` 和 `_icon` 属性，自定义标签外观和字体加粗
- 🖱️ **可拖拽悬浮栏** - 悬浮标签栏可自由拖拽定位，避免与窗口拖拽功能冲突
- 💾 **位置持久化** - 标签栏位置自动保存，应用重启后保持一致
- 🔍 **背景模糊效果** - 2px 模糊强度的毛玻璃效果，提升视觉体验
- 📊 **智能数量控制** - 根据 `orca.state.settings[13]` 设置控制最大标签数量
- 🔄 **实时更新** - 监听DOM变化，自动更新标签状态
- 📌 **标签固定功能** - 支持固定标签，固定标签会置顶显示且不会被"关闭全部"操作影响，也不会被新标签页替换
- 🖱️ **多种关闭方式** - 支持中键点击、右键菜单等多种关闭标签方式

## 安装

```bash
npm install
npm run build
```

构建完成后，将 `dist/index.js` 文件复制到 Orca Note 的插件目录，

> 💡 提示：安装后可能需要重启 Orca Note 应用才能生效

> 💡 提示：右侧有编译好的，下载以后在插件目录



## 使用

插件启动后会自动检测并创建悬浮标签栏：

1. **自动检测面板** - 读取 `section#main` 下 `.orca-panels-row` 中的所有 `.orca-panel` 面板
2. **提取编辑器块** - 从每个面板的 `.orca-hideable` 中提取 `.orca-block-editor` 的 `data-block-id`
3. **智能命名** - 优先使用 `BlockAlias`，其次是 `_repr` 值（日期块），最后使用 `BlockProperty` 内容
4. **个性化样式** - 读取 `_color` 和 `_icon` 属性，设置60%透明背景色和700字重
5. **拖拽定位** - 通过左侧拖拽手柄移动标签栏，位置自动保存
6. **快速切换** - 点击标签直接跳转到对应的块和面板

### 标签固定功能

- **固定标签**：双击标签可以切换标签的固定状态
- **固定标识**：固定标签会显示 📌 图标，并自动排序到标签栏最前面
- **保护机制**：固定标签不会被"关闭全部"操作影响，也不会被新标签页替换
- **智能插入**：在固定标签上打开新标签时，新标签会自动插入到固定标签的后面
- **手动关闭**：固定标签需要手动关闭，确保重要标签不会意外丢失

### 关闭标签功能

- **中键点击**：使用鼠标中键点击标签可以关闭该标签
- **右键菜单**：右键点击标签显示上下文菜单，包含：
  - 固定/取消固定标签
  - 关闭标签
  - 关闭其他标签
  - 关闭全部标签
- **保护限制**：只有一个标签时无法关闭，固定标签默认不可关闭

## 块属性支持

- `_color` - 设置标签背景色（60%透明度）和文字颜色，需要 `type=1`
- `_icon` - 设置标签图标（emoji或文本），需要 `type=1`

> 注意：只有同时具有 `_color` 和 `_icon` 属性的标签才会应用加粗字体（font-weight: 700）

## 技术实现

### 数据读取流程
1. 扫描 `.orca-panel` 获取 `data-panel-id`
2. 按用户操作顺序读取 `.orca-hideable` 下的编辑器块
3. 提取 `data-block-id` 并限制在最大标签数量内
4. 调用后端API获取块信息、别名、属性等

### 标签命名优先级
1. **BlockAlias** - 块别名（最高优先级）
2. **_repr值** - 日期块的表示值
3. **BlockProperty** - content中的文本内容

### 样式系统
- 默认：浅灰背景，普通字重
- 有色彩：自定义背景色（60%透明），匹配文字颜色，加粗字体
- 背景模糊：2px模糊强度的毛玻璃效果


## 常见问题

**Q: 标签栏什么时候会显示？**
A: 当检测到活跃的编辑器块时自动显示，会实时监听DOM变化

**Q: 为什么有些标签没有颜色？**
A: 只有同时设置了 `_color` 和 `_icon` 属性且 `type=1` 的块才会显示自定义颜色

**Q: 标签数量有限制吗？**
A: 是的，受 `orca.state.settings[13]` 设置控制，默认最大10个标签

**Q: 标签栏位置会丢失吗？**
A: 不会，位置保存在 localStorage 中，应用重启后自动恢复

**Q: 拖拽时会触发窗口移动吗？**
A: 不会，插件使用 `stopPropagation()` 防止与窗口拖拽功能冲突

**Q: 支持哪些标签内容？**
A: 支持普通文本块、日期块（journal类型）、带别名的块等

**Q: 标签顺序是怎么确定的？**
A: 按用户操作顺序，新点击的块会插入到最前面而不是尾部

**Q: 如何关闭插件？**
A: 在 Orca Note 插件设置中禁用，或调用 `unload()` 函数清理资源

**Q: 如何固定标签？**
A: 双击标签可以切换标签的固定状态

**Q: 固定标签有什么作用？**
A: 固定标签会置顶显示，不会被"关闭全部"操作影响，适合保留重要的标签

**Q: 如何关闭标签？**
A: 可以使用中键点击或右键菜单来关闭标签

**Q: 为什么有些标签无法关闭？**
A: 固定标签默认不可关闭，只有一个标签时也无法关闭

**Q: 固定标签会被新标签页替换吗？**
A: 不会！v2.1.5版本已修复此问题，固定标签永远不会被替换，新标签页会插入到固定标签的后面

**Q: 在固定标签上打开新标签会发生什么？**
A: 新标签会自动插入到固定标签的后面，保持固定标签的位置和状态不变



